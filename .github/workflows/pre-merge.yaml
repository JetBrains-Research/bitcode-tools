name: Pre Merge Checks

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '*'

jobs:
  gradle:
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest ]
    runs-on: ${{ matrix.os }}
    env:
      GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
      GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
    if: ${{ !contains(github.event.head_commit.message, 'ci skip') }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4
      - name: Cache Gradle Caches
        uses: gradle/gradle-build-action@v2

      # Set up necessary dependencies
      - name: Set up LLVM for `llvm-dis` tool
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: '14.0'
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      - name: Install Python dependencies
        run: pip install -r requirements.txt

        # Run all linters and unit tests
      - name: Run Gradle verification tasks
        run: ./gradlew preMerge --continue

        # Test `:example:decompileBitcode` task
      - name: Run `decompileBitcode` task
        run: ./gradlew :example:decompileBitcode --output "build/bitcode/bitcode.ll"
        if: success()
      - name: Verify `decompileBitcode` output
        run: test -f example/build/bitcode/bitcode.ll
        if: success()

        # Test `:example:extractBitcode` task
      - name: Run `extractBitcode` task
        run: ./gradlew :example:extractBitcode --function 'kfun:#main(){}' --output "build/bitcode/main-bitcode.ll"
        if: success()
      - name: Verify `extractBitcode` output
        run: test -f example/build/bitcode/main-bitcode.ll
        if: success()

        # Test `:example:extractSomeBitcode` task
      - name: Run standalone `extractSomeBitcode` task
        run: ./gradlew :example:extractSomeBitcode --function 'kfun:#main(){}' --input "build/bitcode/bitcode.ll" --output "build/bitcode/main-bitcode-by-standalone.ll"
        if: success()
      - name: Verify `extractSomeBitcode` output
        run: test -f example/build/bitcode/main-bitcode-by-standalone.ll
        if: success()
